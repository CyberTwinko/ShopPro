stages:
  - install
  - lint
  - documentation
  - test
  - build
  - deploy

variables:
  NODE_ENV: production
  NODE_OPTIONS: --max-old-space-size=4096
  NPM_CACHE_DIR: .npm
  AWS_DEFAULT_REGION: us-east-1
  # AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, S3_BUCKET, EB_APPLICATION_NAME, EB_ENVIRONMENT_NAME set in GitLab CI/CD variables

cache:
  key: "${CI_COMMIT_REF_SLUG}-node-modules"
  paths:
    - .npm/
    - node_modules/
    - backend/node_modules/
    - frontend/node_modules/

# ==================== INSTALL STAGE ====================
.install_template: &install_template
  stage: install
  image: node:22-alpine
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

install_dependencies:
  <<: *install_template
  script:
    - echo "Installing root dependencies..."
    - npm ci --prefer-offline --no-audit
    - echo "Installing backend dependencies..."
    - cd backend && npm ci --prefer-offline --no-audit && cd ..
    - echo "Installing frontend dependencies..."
    - cd frontend && npm ci --prefer-offline --no-audit && cd ..
    - echo "All dependencies installed successfully"
  artifacts:
    paths:
      - node_modules/
      - backend/node_modules/
      - frontend/node_modules/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

# ==================== LINT STAGE ====================
.lint_template: &lint_template
  stage: lint
  image: node:22-alpine

lint_backend:
  <<: *lint_template
  needs:
    - install_dependencies
  script:
    - cd backend
    - npm ci --prefer-offline --no-audit --omit=optional
    - npx eslint . --ext .js --format json --output-file eslint-report.json --config .eslintrc.json || true
  artifacts:
    reports:
      sast: backend/eslint-report.json
    paths:
      - backend/eslint-report.json
    expire_in: 30 days
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests

lint_frontend:
  <<: *lint_template
  needs:
    - install_dependencies
  script:
    - cd frontend
    - npm ci --prefer-offline --no-audit --omit=optional
    - npx eslint src --ext .js,.jsx --format json --output-file eslint-report.json --config .eslintrc.json || true
  artifacts:
    reports:
      sast: frontend/eslint-report.json
    paths:
      - frontend/eslint-report.json
    expire_in: 30 days
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests

# ==================== DOCUMENTATION STAGE ====================
documentation_generate:
  stage: documentation
  image: node:22-alpine
  needs:
    - install_dependencies
  before_script:
    - apk add --no-cache git
  script:
    - npm install -g jsdoc
    - mkdir -p docs/backend docs/frontend
    - find backend/controllers backend/models backend/routes backend/middleware -name "*.js" -type f | xargs jsdoc -d docs/backend 2>/dev/null || echo "Backend docs done with warnings"
    - find frontend/src/components frontend/src/screens frontend/src/slices -name "*.js*" -type f 2>/dev/null | xargs jsdoc -d docs/frontend 2>/dev/null || echo "Frontend docs done with warnings"
  artifacts:
    paths:
      - docs/
    expire_in: 30 days
  allow_failure: true
  only:
    - main
    - develop

# ==================== TEST STAGE ====================
test_backend:
  stage: test
  image: node:22-alpine
  needs:
    - install_dependencies
  script:
    - cd backend
    - npm run test -- --coverage
  artifacts:
    when: always
    paths:
      - backend/coverage/
      - backend/junit.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage/cobertura-coverage.xml
      junit: backend/junit.xml
    expire_in: 30 days
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests

# ==================== BUILD STAGE ====================
build_app:
  stage: build
  image: node:22
  needs:
    - lint_backend
    - test_backend
    - lint_frontend
    - documentation_generate
  script:
    # Build frontend
    - cd frontend && npm run build && cd ..

    # Prepare deploy folder
    - rm -rf backend/deploy
    - mkdir -p backend/deploy

    # Copy backend files (without node_modules and without .env.example)
    - cp -r backend/controllers backend/models backend/routes backend/middleware backend/utils backend/config backend/server.js backend/package*.json backend/deploy/

    # Copy frontend build into backend deploy folder
    - cp -r frontend/build backend/deploy/public

    # Copy generated docs
    - cp -r docs backend/deploy/docs

    # Move into deploy folder and zip contents (contents at root)
    - cd backend/deploy
    - zip -r ../backend-app.zip ./*
    - cd ../..

  artifacts:
    paths:
      - backend/backend-app.zip
    expire_in: 1 day
  only:
    - main
    - develop

# ==================== DEPLOY STAGE ====================
deploy_aws_production:
  stage: deploy
  image: alpine:latest
  needs:
    - build_app
  before_script:
    - apk add --no-cache aws-cli zip
  script:
    - aws s3 cp backend/backend-app.zip s3://${S3_BUCKET}/backend-app-${CI_COMMIT_SHORT_SHA}.zip --region ${AWS_DEFAULT_REGION}
    - aws elasticbeanstalk create-application-version --application-name ${EB_APPLICATION_NAME} --version-label ${CI_COMMIT_SHORT_SHA} --source-bundle S3Bucket=${S3_BUCKET},S3Key=backend-app-${CI_COMMIT_SHORT_SHA}.zip --region ${AWS_DEFAULT_REGION}
    - aws elasticbeanstalk update-environment --application-name ${EB_APPLICATION_NAME} --environment-name ${EB_ENVIRONMENT_NAME} --version-label ${CI_COMMIT_SHORT_SHA} --region ${AWS_DEFAULT_REGION}
  environment:
    name: production
    url: https://your-domain.com
  only:
    - main
  when: manual