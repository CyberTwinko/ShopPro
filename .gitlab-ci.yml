stages:
  - install
  - lint
  - documentation
  - test
  - build
  - deploy

variables:
  NODE_ENV: production
  NODE_OPTIONS: --max-old-space-size=4096
  NPM_CACHE_DIR: .npm
  AWS_DEFAULT_REGION: us-east-1
  # AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, S3_BUCKET, CLOUDFRONT_DISTRIBUTION_ID should be set in GitLab CI/CD variables

# Global cache configuration
cache:
  key: "${CI_COMMIT_REF_SLUG}-node-modules"
  paths:
    - .npm/
    - node_modules/
    - backend/node_modules/
    - frontend/node_modules/

# ==================== INSTALL STAGE ====================
.install_template: &install_template
  stage: install
  image: node:22-alpine
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

install_dependencies:
  <<: *install_template
  script:
    - echo "Installing root dependencies..."
    - npm ci --prefer-offline --no-audit
    - echo "Installing backend dependencies..."
    - cd backend && npm ci --prefer-offline --no-audit && cd ..
    - echo "Installing frontend dependencies..."
    - cd frontend && npm ci --prefer-offline --no-audit && cd ..
    - echo "All dependencies installed successfully"
  artifacts:
    paths:
      - node_modules/
      - backend/node_modules/
      - frontend/node_modules/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

# ==================== LINT STAGE ====================
.lint_template: &lint_template
  stage: lint
  image: node:22-alpine

lint_backend:
  <<: *lint_template
  needs:
    - job: install_dependencies
  script:
    - cd backend
    - echo "Installing backend dev dependencies for linting..."
    - npm ci --prefer-offline --no-audit --omit=optional
    - echo "Linting backend code..."
    - npx eslint . --ext .js --format json --output-file eslint-report.json --config .eslintrc.json || true
    - echo "ESLint output:"
    - cat eslint-report.json || echo "No eslint-report.json generated"
  artifacts:
    reports:
      sast: backend/eslint-report.json
    paths:
      - backend/eslint-report.json
    expire_in: 30 days
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests

lint_frontend:
  <<: *lint_template
  needs:
    - job: install_dependencies
  script:
    - cd frontend
    - echo "Installing frontend dev dependencies for linting..."
    - npm ci --prefer-offline --no-audit --omit=optional
    - echo "Linting frontend code..."
    - npx eslint src --ext .js,.jsx --format json --output-file eslint-report.json --config .eslintrc.json || true
    - echo "ESLint output:"
    - cat eslint-report.json || echo "No eslint-report.json generated"
  artifacts:
    reports:
      sast: frontend/eslint-report.json
    paths:
      - frontend/eslint-report.json
    expire_in: 30 days
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests

# ==================== DOCUMENTATION STAGE ====================
documentation_generate:
  stage: documentation
  image: node:22-alpine
  needs:
    - job: install_dependencies
  before_script:
    - apk add --no-cache git
  script:
    - echo "Installing JSDoc..."
    - npm install -g jsdoc
    - mkdir -p docs/backend docs/frontend
    - find backend/controllers backend/models backend/routes backend/middleware -name "*.js" -type f | xargs jsdoc -d docs/backend 2>/dev/null || echo "Backend docs done with warnings"
    - find frontend/src/components frontend/src/screens frontend/src/slices -name "*.js*" -type f 2>/dev/null | xargs jsdoc -d docs/frontend 2>/dev/null || echo "Frontend docs done with warnings"
  artifacts:
    paths:
      - docs/
    expire_in: 30 days
  allow_failure: true
  only:
    - main
    - develop

# ==================== TEST STAGE ====================
.test_template: &test_template
  stage: test
  image: node:22-alpine
  retry:
    max: 1
    when:
      - runner_system_failure

test_backend_unit:
  <<: *test_template
  needs:
    - job: install_dependencies
  script:
    - cd backend
    - echo "Running backend unit tests..."
    - npm test -- tests/userController.test.js -- --coverage --detectOpenHandles
  coverage: '/Statements\s*:\s*(\d+\.\d+)%/'
  artifacts:
    when: always
    paths:
      - backend/coverage/
      - backend/junit.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage/cobertura-coverage.xml
      junit: backend/junit.xml
    expire_in: 30 days
  only:
    - main
    - develop
    - merge_requests

test_frontend_unit:
  <<: *test_template
  needs:
    - job: install_dependencies
  script:
    - cd frontend
    - echo "Running frontend unit tests..."
    - npm test -- --coverage --watchAll=false --testResultsProcessor=jest-junit --detectOpenHandles || true
  coverage: '/Statements\s*:\s*(\d+\.\d+)%/'
  artifacts:
    when: always
    paths:
      - frontend/coverage/
      - frontend/junit.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: frontend/coverage/cobertura-coverage.xml
      junit: frontend/junit.xml
    expire_in: 30 days
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests

test_integration:
  <<: *test_template
  needs:
    - job: install_dependencies
  script:
    - cd backend
    - echo "Running integration tests..."
    - npm test -- tests/integration --detectOpenHandles 2>/dev/null || echo "No integration tests configured"
  allow_failure: true
  only:
    - main
    - develop

# ==================== BUILD STAGE ====================
app_build:
  stage: build
  image: node:22-alpine
  retry:
    max: 1
    when:
      - runner_system_failure
  needs:
    - job: lint_backend
    - job: lint_frontend
    - job: test_backend_unit
    - job: test_frontend_unit
    - job: documentation_generate
  script:
    - echo "ðŸ“¦ Unified build started"

    # ---- FRONTEND BUILD ----
    - cd frontend
    - npm run build || { echo "Frontend build failed"; exit 1; }
    - cd ..

    # ---- BACKEND BUILD ----
    - cd backend
    - mkdir -p dist
    - cp -r controllers models routes middleware utils config dist/ 2>/dev/null || true
    - cp server.js .env.example dist/ 2>/dev/null || true
    - cp package.json package-lock.json dist/

    # Copy frontend build into backend/public
    - mkdir -p dist/public
    - cp -r ../frontend/build dist/public

    # Copy docs
    - if [ -d "../docs" ]; then cp -r ../docs dist/docs; fi

    # Install backend production deps into dist
    - cd dist
    - npm ci --omit=dev --prefer-offline --no-audit
    - cd ../..

    # ---- ZIP BUILD ----
    - apk add --no-cache zip
    - zip -r app-bundle.zip backend/dist/*

  artifacts:
    paths:
      - app-bundle.zip
      - backend/dist/
      - frontend/build/
    expire_in: 1 day
  only:
    - main
    - develop


# ==================== DEPLOY STAGE ====================
.deploy_template: &deploy_template
  image: alpine:latest
  retry:
    max: 1
    when:
      - runner_system_failure

deploy_aws_production:
  <<: *deploy_template
  stage: deploy
  needs:
    - job: backend_build
    - job: frontend_build
    - job: documentation_generate
  before_script:
    - apk add --no-cache aws-cli zip
  script:
    - echo "ðŸš€ Deploying to AWS Elastic Beanstalk (Production)..."
    - echo "ðŸ“¦ Uploading backend app to S3..."
    - aws s3 cp backend/backend-app.zip s3://${S3_BUCKET}/backend-app-${CI_COMMIT_SHORT_SHA}.zip --region ${AWS_DEFAULT_REGION}
    - echo "âœ… Backend app uploaded to s3://${S3_BUCKET}/backend-app-${CI_COMMIT_SHORT_SHA}.zip"
    - echo "ðŸ“‹ Creating Elastic Beanstalk application version..."
    - aws elasticbeanstalk create-application-version --application-name ${EB_APPLICATION_NAME} --version-label ${CI_COMMIT_SHORT_SHA} --source-bundle S3Bucket=${S3_BUCKET},S3Key=backend-app-${CI_COMMIT_SHORT_SHA}.zip --region ${AWS_DEFAULT_REGION}
    - echo "ðŸ”„ Updating Elastic Beanstalk environment..."
    - aws elasticbeanstalk update-environment --application-name ${EB_APPLICATION_NAME} --environment-name ${EB_ENVIRONMENT_NAME} --version-label ${CI_COMMIT_SHORT_SHA} --region ${AWS_DEFAULT_REGION}
    - echo "âœ… Production deployment initiated"
  environment:
    name: production
    url: https://your-domain.com (Change this to the EB domain)
  only:
    - main
  when: manual

# deploy_aws_staging:
#   <<: *deploy_template
#   stage: deploy
#   needs:
#     - job: backend_build
#     - job: frontend_build
#   before_script:
#     - apk add --no-cache aws-cli zip
#   script:
#     - echo "ðŸš€ Deploying to AWS Elastic Beanstalk (Staging)..."
#     - echo "ðŸ“¦ Uploading backend app to S3..."
#     - aws s3 cp backend/backend-app.zip s3://${S3_BUCKET}/backend-app-staging-${CI_COMMIT_SHORT_SHA}.zip --region ${AWS_DEFAULT_REGION}
#     - echo "âœ… Backend app uploaded to s3://${S3_BUCKET}/backend-app-staging-${CI_COMMIT_SHORT_SHA}.zip"
#     - echo "ðŸ“‹ Creating Elastic Beanstalk application version..."
#     - aws elasticbeanstalk create-application-version --application-name ${EB_APPLICATION_NAME} --version-label staging-${CI_COMMIT_SHORT_SHA} --source-bundle S3Bucket=${S3_BUCKET},S3Key=backend-app-staging-${CI_COMMIT_SHORT_SHA}.zip --region ${AWS_DEFAULT_REGION}
#     - echo "ðŸ”„ Updating Elastic Beanstalk environment (Staging)..."
#     - aws elasticbeanstalk update-environment --application-name ${EB_APPLICATION_NAME} --environment-name ${EB_ENVIRONMENT_NAME_STAGING} --version-label staging-${CI_COMMIT_SHORT_SHA} --region ${AWS_DEFAULT_REGION}
#     - echo "âœ… Staging deployment initiated"
#   environment:
#     name: staging
#     url: https://staging.your-domain.com
#   only:
#     - develop
#   when: manual